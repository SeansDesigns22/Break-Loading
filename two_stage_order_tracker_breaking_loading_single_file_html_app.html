<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Tracker – Breaking & Loading</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:Inter,system-ui; background:#0b1220; color:#e5e7eb}
    .input{background:#0c1426; border:1px solid rgba(255,255,255,.1); border-radius:.6rem; padding:.6rem; color:inherit}
    .btn{border-radius:.6rem; padding:.5rem .8rem; font-weight:600}
    .btn-primary{background:#60a5fa; color:#0b1220}
    .btn-secondary{background:rgba(255,255,255,.1)}
    .btn-danger{background:rgba(239,68,68,.2); color:#ef4444}
    .tab{cursor:pointer; padding:.5rem 1rem; border-radius:.5rem}
    .tab-active{background:rgba(255,255,255,.1)}
    table{border-collapse:separate; border-spacing:0 .3rem}
    th{font-size:.75rem; text-transform:uppercase; color:#94a3b8}
    td{font-size:.9rem}
    tr{background:rgba(255,255,255,.03)}
    .toast{position:fixed; right:1rem; bottom:1rem; background:#111827; border:1px solid rgba(255,255,255,.1); padding:.6rem .8rem; border-radius:.6rem; opacity:0; pointer-events:none; transition:opacity .2s}
    .toast.show{opacity:1}
  </style>
</head>
<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <header class="flex justify-between mb-6">
      <h1 class="text-xl font-bold">Order Builder / Loader</h1>
      <div class="flex gap-2">
        <button id="exportBtn" class="btn btn-secondary" type="button">Export</button>
        <label class="btn btn-secondary cursor-pointer" for="importFile">Import<input id="importFile" type="file" accept="application/json" class="hidden"></label>
        <button id="clearAllBtn" class="btn btn-danger" type="button">Clear</button>
      </div>
    </header>

    <div class="flex gap-2 mb-4">
      <button data-tab="breaking" class="tab tab-active" id="tab-breaking" type="button">Breaking</button>
      <button data-tab="loading" class="tab" id="tab-loading" type="button">Loading</button>
    </div>

    <!-- Breaking Panel -->
    <section id="panel-breaking">
      <form id="breakingForm" class="grid grid-cols-2 gap-3 mb-6">
        <div><label class="text-sm text-slate-400">Mark*</label><input id="brkMark" class="input w-full" required></div>
        <div><label class="text-sm text-slate-400">Order ID*</label><input id="brkOrderId" class="input w-full" required></div>
        <div><label class="text-sm text-slate-400">Bale Count</label><input id="brkBales" type="number" class="input w-full" min="0"></div>
        <div><label class="text-sm text-slate-400">Status</label><select id="brkStatus" class="input w-full"><option>Incomplete</option><option>In Progress</option><option>Completed</option></select></div>
        <div><label class="text-sm text-slate-400">Breaker</label><input id="brkBreaker" class="input w-full"></div>
        <div><label class="text-sm text-slate-400">Hauler / Proofer</label><input id="brkHauler" class="input w-full"></div>
        <div><label class="text-sm text-slate-400">Date to Load</label><input id="brkDateToLoad" type="date" class="input w-full"></div>
        <div><label class="text-sm text-slate-400">Completed Date</label><input id="brkCompletedDate" type="date" class="input w-full"></div>
        <div><label class="text-sm text-slate-400">Location</label><input id="brkLocation" class="input w-full"></div>
        <label class="flex items-center gap-2"><input type="checkbox" id="brkReady"> Ready to break</label>
        <button class="btn btn-primary col-span-2" id="brkSaveBtn" type="submit">Save / Update</button>
      </form>
      <table class="w-full">
        <thead><tr><th>Mark</th><th>Order ID</th><th>Bales</th><th>Status</th><th>Breaker</th><th>Hauler</th><th>Date to Load</th><th>Completed</th><th>Location</th><th>Ready?</th><th></th></tr></thead>
        <tbody id="breakingTbody"></tbody>
      </table>
    </section>

    <!-- Loading Panel -->
    <section id="panel-loading" class="hidden">
      <form id="loadingForm" class="grid grid-cols-2 gap-3 mb-6">
        <div class="col-span-2"><label class="text-sm text-slate-400">Lookup by Mark (autofills from Breaking)</label><input id="ldMark" class="input w-full" placeholder="Type a Mark…"></div>
        <div><label class="text-sm text-slate-400">Order ID</label><input id="ldOrderId" class="input w-full" readonly></div>
        <div><label class="text-sm text-slate-400">Bale Count</label><input id="ldBales" class="input w-full" readonly></div>
        <div><label class="text-sm text-slate-400">Date to Load</label><input id="ldDateToLoad" class="input w-full" readonly></div>
        <div><label class="text-sm text-slate-400">Location</label><input id="ldLocation" class="input w-full" readonly></div>
        <div><label class="text-sm text-slate-400">Clear Date</label><input id="ldClearDate" type="date" class="input w-full"></div>
        <div><label class="text-sm text-slate-400">Date Loaded</label><input id="ldDateLoaded" type="date" class="input w-full"></div>
        <div><label class="text-sm text-slate-400">Status</label><select id="ldStatus" class="input w-full"><option value="Not Loaded">Not Loaded</option><option value="In Progress">In Progress</option><option value="Loaded">Loaded</option></select></div>
        <div><label class="text-sm text-slate-400">Loaded By</label><input id="ldLoadedBy" class="input w-full"></div>
        <div><label class="text-sm text-slate-400">Type of Load</label><select id="ldType" class="input w-full">
          <option value="">--</option>
          <option>Van</option>
          <option>Container</option>
          <option>Flatbed</option>
        </select></div>
        <div><label class="text-sm text-slate-400">Vehicle ID</label><input id="ldVehicleId" class="input w-full"></div>
        <input id="ldDriverName" class="input hidden" placeholder="Driver Name (stored only)">
        <input id="ldPhone" class="input hidden" placeholder="Phone (stored only)">
        <button class="btn btn-primary col-span-2" id="ldSaveBtn" type="submit">Save / Update</button>
      </form>
      <table class="w-full">
        <thead><tr><th>Mark</th><th>Order ID</th><th>Date to Load</th><th>Loaded?</th><th>Date Loaded</th><th>Type</th><th>Vehicle ID</th><th>Location</th><th>Loaded By</th><th></th></tr></thead>
        <tbody id="loadingTbody"></tbody>
      </table>
    </section>
  </div>

  <div id="toast" class="toast">Saved</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const KEYS={BRK:'breakingOrders',LOD:'loadingOrders'};
  const toastEl = $('#toast');
  function toast(msg){ if(!toastEl) return; toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 900); }

  function safeParse(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ return []; } }
  let breaking=safeParse(KEYS.BRK);
  let loading=safeParse(KEYS.LOD);
  let editBrk=null,editLd=null;

  function save(){ localStorage.setItem(KEYS.BRK,JSON.stringify(breaking)); localStorage.setItem(KEYS.LOD,JSON.stringify(loading)); }

  function statusClass(status){
    if(!status) return 'text-white';
    const s=String(status).toLowerCase().trim();
    if(s==='not loaded' || s==='incomplete') return 'text-red-400';
    if(s==='in progress') return 'text-amber-400';
    if(s==='completed' || s==='loaded') return 'text-green-400';
    return 'text-white';
  }
  function rowClassByReadyAndStatus(ready,status){
    if(status){ const sc=statusClass(status); if(sc!=="text-white") return sc; }
    return ready? 'text-white' : 'text-red-400';
  }
  function parseDate(d){ if(!d) return Infinity; const t=Date.parse(d); return isNaN(t)?Infinity:t; }

  function renderBreaking(){
    const tb=$('#breakingTbody'); tb.innerHTML='';
    const rows=[...breaking].sort((a,b)=>{ const da=parseDate(a.dateToLoad), db=parseDate(b.dateToLoad); if(da!==db) return da-db; return (a.mark||'').localeCompare(b.mark||''); });
    for(const r of rows){
      const color=rowClassByReadyAndStatus(!!r.ready, r.status||'');
      tb.insertAdjacentHTML('beforeend',`
        <tr class="${color}">
          <td>${r.mark||''}</td>
          <td>${r.orderId||''}</td>
          <td>${r.bales||''}</td>
          <td class="${statusClass(r.status)}">${r.status||''}</td>
          <td>${r.breaker||''}</td>
          <td>${r.hauler||''}</td>
          <td>${r.dateToLoad||''}</td>
          <td>${r.completedDate||''}</td>
          <td>${r.location||''}</td>
          <td>${r.ready?'Yes':'No'}</td>
          <td><button class="btn btn-secondary" type="button" data-edit-brk="${r.id}">Edit</button> <button class="btn btn-danger" type="button" data-del-brk="${r.id}">Del</button></td>
        </tr>`);
    }
    tb.querySelectorAll('[data-edit-brk]').forEach(b=> b.onclick=()=> editBreaking(b.dataset.editBrk));
    tb.querySelectorAll('[data-del-brk]').forEach(b=> b.onclick=()=> delBreaking(b.dataset.delBrk));
  }

  function renderLoading(){
    const tb=$('#loadingTbody'); tb.innerHTML='';
    const rows=[...loading].sort((a,b)=>{ const da=parseDate(a.dateToLoad), db=parseDate(b.dateToLoad); if(da!==db) return da-db; return (a.mark||'').localeCompare(b.mark||''); });
    for(const r of rows){
      tb.insertAdjacentHTML('beforeend',`
        <tr class="${statusClass(r.status||'')}">
          <td>${r.mark||''}</td>
          <td>${r.orderId||''}</td>
          <td>${r.dateToLoad||''}</td>
          <td class="${statusClass(r.status)}">${r.status||''}</td>
          <td>${r.dateLoaded||''}</td>
          <td>${r.type||''}</td>
          <td>${r.vehicleId||''}</td>
          <td>${r.location||''}</td>
          <td>${r.loadedBy||''}</td>
          <td><button class="btn btn-secondary" type="button" data-edit-ld="${r.id}">Edit</button> <button class="btn btn-danger" type="button" data-del-ld="${r.id}">Del</button></td>
        </tr>`);
    }
    tb.querySelectorAll('[data-edit-ld]').forEach(b=> b.onclick=()=> editLoading(b.dataset.editLd));
    tb.querySelectorAll('[data-del-ld]').forEach(b=> b.onclick=()=> delLoading(b.dataset.delLd));
  }

  // --- Breaking form ---
  $('#breakingForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const rec={
      id: editBrk || (crypto.randomUUID? crypto.randomUUID(): 'id_'+Math.random().toString(36).slice(2)),
      mark: $('#brkMark').value.trim(),
      orderId: $('#brkOrderId').value.trim(),
      bales: Number($('#brkBales').value||0),
      status: $('#brkStatus').value,
      breaker: $('#brkBreaker').value.trim(),
      hauler: $('#brkHauler').value.trim(),
      dateToLoad: $('#brkDateToLoad').value,
      completedDate: $('#brkCompletedDate').value,
      location: $('#brkLocation').value.trim(),
      ready: $('#brkReady').checked
    };
    if(!rec.mark || !rec.orderId){ alert('Mark and Order ID are required.'); return; }

    const idx=breaking.findIndex(x=> (x.mark||'').toLowerCase()===rec.mark.toLowerCase());
    if(idx>-1 && !editBrk){ rec.id=breaking[idx].id; breaking[idx]=rec; }
    else if(editBrk){ const i=breaking.findIndex(x=>x.id===editBrk); if(i>-1) breaking[i]=rec; else breaking.push(rec); }
    else { breaking.push(rec); }

    editBrk=null; save(); renderBreaking(); e.target.reset(); toast('Saved Breaking');
  });

  function editBreaking(id){
    const r=breaking.find(x=>x.id===id); if(!r) return; editBrk=id;
    $('#brkMark').value=r.mark||''; $('#brkOrderId').value=r.orderId||''; $('#brkBales').value=r.bales||''; $('#brkStatus').value=r.status||'Incomplete'; $('#brkBreaker').value=r.breaker||''; $('#brkHauler').value=r.hauler||''; $('#brkDateToLoad').value=r.dateToLoad||''; $('#brkCompletedDate').value=r.completedDate||''; $('#brkLocation').value=r.location||''; $('#brkReady').checked=!!r.ready;
  }
  function delBreaking(id){ if(!confirm('Delete this Breaking record?')) return; breaking=breaking.filter(x=>x.id!==id); save(); renderBreaking(); toast('Deleted'); }

  // --- Loading form ---
  function applyAutofillFromBreaking(mark){
    const mk=(mark||'').trim().toLowerCase(); if(!mk){ $('#ldOrderId').value=''; $('#ldBales').value=''; $('#ldDateToLoad').value=''; $('#ldLocation').value=''; return null; }
    const match=breaking.find(b=> (b.mark||'').toLowerCase()===mk);
    if(match){ $('#ldOrderId').value=match.orderId||''; $('#ldBales').value=match.bales||''; $('#ldDateToLoad').value=match.dateToLoad||''; $('#ldLocation').value=match.location||''; return match; }
    else { $('#ldOrderId').value=''; $('#ldBales').value=''; $('#ldDateToLoad').value=''; $('#ldLocation').value=''; return null; }
  }
  $('#ldMark').addEventListener('input', (e)=> applyAutofillFromBreaking(e.target.value));

  $('#loadingForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const mark=$('#ldMark').value.trim(); if(!mark){ alert('Mark is required'); return; }
    const brk=applyAutofillFromBreaking(mark);
    const rec={
      id: editLd || (crypto.randomUUID? crypto.randomUUID(): 'id_'+Math.random().toString(36).slice(2)),
      mark,
      orderId: $('#ldOrderId').value.trim(),
      dateToLoad: $('#ldDateToLoad').value,
      location: $('#ldLocation').value.trim(),
      clearDate: $('#ldClearDate').value,
      dateLoaded: $('#ldDateLoaded').value,
      status: $('#ldStatus').value,
      loadedBy: $('#ldLoadedBy').value.trim(),
      type: $('#ldType').value,
      vehicleId: $('#ldVehicleId').value.trim(),
      driverName: $('#ldDriverName').value.trim(),
      phone: $('#ldPhone').value.trim()
    };

    const idx=loading.findIndex(x=> (x.mark||'').toLowerCase()===rec.mark.toLowerCase());
    if(idx>-1 && !editLd){ rec.id=loading[idx].id; loading[idx]=rec; }
    else if(editLd){ const i=loading.findIndex(x=>x.id===editLd); if(i>-1) loading[i]=rec; else loading.push(rec); }
    else { loading.push(rec); }

    if(brk && rec.dateLoaded){ const bi=breaking.findIndex(x=>x.id===brk.id); if(bi>-1){ breaking[bi].status='Completed'; save(); renderBreaking(); } }

    editLd=null; save(); renderLoading(); e.target.reset(); toast('Saved Loading');
  });

  function editLoading(id){
    const r=loading.find(x=>x.id===id); if(!r) return; editLd=id;
    $('#ldMark').value=r.mark||''; applyAutofillFromBreaking(r.mark||''); $('#ldClearDate').value=r.clearDate||''; $('#ldDateLoaded').value=r.dateLoaded||''; $('#ldStatus').value=r.status||'Not Loaded'; $('#ldLoadedBy').value=r.loadedBy||''; $('#ldType').value=r.type||''; $('#ldVehicleId').value=r.vehicleId||''; $('#ldDriverName').value=r.driverName||''; $('#ldPhone').value=r.phone||'';
  }
  function delLoading(id){ if(!confirm('Delete this Loading record?')) return; loading = loading.filter(x=>x.id!==id); save(); renderLoading(); toast('Deleted'); }

  // Export / Import / Clear
  $('#exportBtn').onclick = ()=>{
    const data={ breaking, loading, exportedAt:new Date().toISOString(), version:1 };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='order-tracker-data.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
  };
  $('#importFile').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return; const fr=new FileReader();
    fr.onload=()=>{ try{ const obj=JSON.parse(fr.result); if(obj.breaking&&obj.loading){ breaking=obj.breaking; loading=obj.loading; save(); renderBreaking(); renderLoading(); toast('Imported'); } else { alert('Invalid file'); } }catch(err){ alert('Failed to parse'); } };
    fr.readAsText(file); e.target.value='';
  });
  $('#clearAllBtn').onclick=()=>{ if(!confirm('Delete ALL local data?')) return; breaking=[]; loading=[]; save(); renderBreaking(); renderLoading(); toast('Cleared'); };

  // Tabs
  $('#tab-breaking').onclick=()=>{ $('#panel-breaking').classList.remove('hidden'); $('#panel-loading').classList.add('hidden'); $('#tab-breaking').classList.add('tab-active'); $('#tab-loading').classList.remove('tab-active'); };
  $('#tab-loading').onclick=()=>{ $('#panel-loading').classList.remove('hidden'); $('#panel-breaking').classList.add('hidden'); $('#tab-loading').classList.add('tab-active'); $('#tab-breaking').classList.remove('tab-active'); };

  // Initial paint
  renderBreaking();
  renderLoading();
})();
</script>
</body>
</html>
